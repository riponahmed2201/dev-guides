# Build Cache Optimization ЁЯЪА

ржбржХрж╛рж░ ржЗржорзЗржЬ ржмрж┐рж▓рзНржб ржХрж░рж╛рж░ рж╕ржорзЯ рж╕ржорзЯрзЗрж░ ржЕржкржЪрзЯ ржХржорж╛рждрзЗ ржПржмржВ ржПржлрж┐рж╢рж┐рзЯрзЗржирзНрж╕рж┐ ржмрж╛рзЬрж╛рждрзЗ **Build Cache Optimization** ржЕрждрзНржпржирзНржд ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржгред рж╕ржарж┐ржХ ржЙржкрж╛рзЯрзЗ ржХрзНржпрж╛рж╢ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж▓рзЗ ржХрзЯрзЗржХ ржорж┐ржирж┐ржЯрзЗрж░ ржмрж┐рж▓рзНржб ржкрзНрж░рж╕рзЗрж╕ ржорж╛рждрзНрж░ ржХрзЯрзЗржХ рж╕рзЗржХрзЗржирзНржбрзЗ ржирж╛ржорж┐рзЯрзЗ ржЖржирж╛ рж╕ржорзНржнржмред

---

## рзз. ржбржХрж╛рж░ рж▓рзЗржпрж╝рж╛рж░ ржХрзНржпрж╛рж╢рж┐ржВ (Layer Caching)

ржбржХрж╛рж░ ржкрзНрж░рждрж┐ржЯрж┐ ржЗржирзНрж╕ржЯрзНрж░рж╛ржХрж╢ржиржХрзЗ (`RUN`, `COPY`, `ADD`) ржПржХржЯрж┐ ржЖрж▓рж╛ржжрж╛ рж▓рзЗрзЯрж╛рж░ рж╣рж┐рж╕рзЗржмрзЗ рж╕рзЗржн ржХрж░рзЗред 
- ржпржЦржи ржЖржкржирж┐ ржкрзБржирж░рж╛рзЯ ржмрж┐рж▓рзНржб ржХрж░рзЗржи, ржбржХрж╛рж░ ржЪрзЗржХ ржХрж░рзЗ ржжрзЗржЦрзЗ рж╕рзЗржЗ рж▓рзЗрзЯрж╛рж░рзЗ ржХрзЛржирзЛ ржкрж░рж┐ржмрж░рзНрждржи рж╣рзЯрзЗржЫрзЗ ржХрж┐ржирж╛ред
- ржпржжрж┐ ржкрж░рж┐ржмрж░рзНрждржи ржирж╛ рж╣рзЯ, рждржмрзЗ ржбржХрж╛рж░ ржЖржЧрзЗрж░ ржЬрзЗржирж╛рж░рзЗржЯ ржХрж░рж╛ ржХрзНржпрж╛рж╢ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗред
- **ржоржирзЗ рж░рж╛ржЦржмрзЗржи:** ржпржжрж┐ ржХрзЛржирзЛ рж▓рзЗрзЯрж╛рж░рзЗрж░ ржХрзНржпрж╛рж╢ ржЗржиржнрзНржпрж╛рж▓рж┐ржб (Invalid) рж╣рзЯ, рждржмрзЗ рждрж╛рж░ ржкрж░рзЗрж░ рж╕ржм рж▓рзЗрзЯрж╛рж░ ржкрзБржирж░рж╛рзЯ ржмрж┐рж▓рзНржб рж╣ржмрзЗред

---

## рзи. ржХрзНржпрж╛рж╢ ржорж╛ржЙржирзНржЯрж┐ржВ (Cache Mounting)

BuildKit-ржПрж░ ржПржХржЯрж┐ ржкрж╛ржУрзЯрж╛рж░ржлрзБрж▓ ржлрж┐ржЪрж╛рж░ рж╣рж▓рзЛ `type=cache` ржорж╛ржЙржирзНржЯред ржПржЯрж┐ ржмрж┐рж╢рзЗрж╖ ржХрж░рзЗ ржкрзНржпрж╛ржХрзЗржЬ ржорзНржпрж╛ржирзЗржЬрж╛рж░ржЧрзБрж▓рзЛрж░ (`pip`, `npm`, `apt`) ржЬржирзНржп ржЦрзБржм ржХрж╛рж░рзНржпржХрж░ред

```dockerfile
# Pip-ржПрж░ ржЬржирзНржп ржХрзНржпрж╛рж╢ ржорж╛ржЙржирзНржЯ ржЙржжрж╛рж╣рж░ржг
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install -r requirements.txt
```
**рж╕рзБржмрж┐ржзрж╛:** ржпржжрж┐ ржЖржкржирж┐ `requirements.txt`-ржП ржПржХржЯрж┐ ржирждрзБржи ржкрзНржпрж╛ржХрзЗржЬ ржпрзЛржЧ ржХрж░рзЗржи, рждржмрзЗ ржбржХрж╛рж░ рж╢рзБржзрзБржорж╛рждрзНрж░ рж╕рзЗржЗ ржкрзНржпрж╛ржХрзЗржЬржЯрж┐ ржбрж╛ржЙржирж▓рзЛржб ржХрж░ржмрзЗ, ржЖржЧрзЗрж░ ржкрзНржпрж╛ржХрзЗржЯржЧрзБрж▓рзЛ ржХрзНржпрж╛рж╢ ржерзЗржХрзЗ ржирж┐рзЯрзЗ ржирзЗржмрзЗред

---

## рзй. ржорж╛рж▓рзНржЯрж┐-рж╕рзНржЯрзЗржЬ ржХрзНржпрж╛рж╢рж┐ржВ (Multi-stage Caching)

ржорж╛рж▓рзНржЯрж┐-рж╕рзНржЯрзЗржЬ ржмрж┐рж▓рзНржбрзЗ рж╢рзБржзрзБржорж╛рждрзНрж░ ржлрж╛ржЗржирж╛рж▓ рж╕рзНржЯрзЗржЬрзЗрж░ ржЗржорзЗржЬ ржЬрзЗржирж╛рж░рзЗржЯ рж╣рзЯред ржХрж┐ржирзНрждрзБ BuildKit ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж▓рзЗ ржЖржкржирж┐ ржЗржирзНржЯрж╛рж░ржорж┐ржбрж┐рзЯрзЗржЯ рж╕рзНржЯрзЗржЬржЧрзБрж▓рзЛржХрзЗржУ ржХрзНржпрж╛рж╢ рж╣рж┐рж╕рзЗржмрзЗ рж╕рзНржЯрзЛрж░ ржХрж░рждрзЗ ржкрж╛рж░рзЗржиред

---

## рзк. ржХрзНржпрж╛рж╢ ржЗржиржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи (Cache Invalidation)

ржХрзНржпрж╛рж╢ ржХржЦржи ржХрж╛ржЬ ржХрж░ржмрзЗ ржирж╛?
- `COPY . .` ржХрж░рж╛рж░ рж╕ржорзЯ ржпржжрж┐ ржХрзЛржирзЛ ржлрж╛ржЗрж▓рзЗ ржкрж░рж┐ржмрж░рзНрждржи рж╣рзЯред
- ржХрзЛржирзЛ `RUN` ржХржорж╛ржирзНржбрзЗрж░ ржЖржЧрзЗ ржпржжрж┐ ржЕржирзНржп ржХрзЛржирзЛ рж▓рзЗрзЯрж╛рж░ ржкрж░рж┐ржмрж░рзНрждржи рж╣рзЯред

**ржмрзЗрж╕рзНржЯ ржкрзНрж░рзНржпрж╛ржХржЯрж┐рж╕:** ржбржХрж╛рж░ржлрж╛ржЗрж▓рзЗ рж╕ржм рж╕ржорзЯ рж╕рзЗржЗ ржлрж╛ржЗрж▓ржЧрзБрж▓рзЛ ржЖржЧрзЗ ржХржкрж┐ ржХрж░рзБржи ржпрж╛ ржШржиржШржи ржкрж░рж┐ржмрж░рзНрждржи рж╣рзЯ ржирж╛ (ржпрзЗржоржи: `package.json` ржмрж╛ `go.mod`)ред

```dockerfile
# ржнрж╛рж▓рзЛ ржкрзНрж░рзНржпрж╛ржХржЯрж┐рж╕
COPY package.json .
RUN npm install
COPY . .
```

---

## рзл. рж░рж┐ржорзЛржЯ ржХрзНржпрж╛рж╢ (Remote Cache)

CI/CD ржкрж╛ржЗржкрж▓рж╛ржЗржирзЗ ржХрж╛ржЬ ржХрж░рж╛рж░ рж╕ржорзЯ ржПржХ ржмрж┐рж▓рзНржбрзЗрж░ ржХрзНржпрж╛рж╢ ржЕржирзНржп ржмрж┐рж▓рзНржбрзЗ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯ ржирж╛ ржХрж╛рж░ржг ржкрзНрж░рждрж┐ржмрж╛рж░ ржПржХржЯрж┐ ржирждрзБржи ржПржиржнрж╛рзЯрж░ржиржорзЗржирзНржЯ рждрзИрж░рж┐ рж╣рзЯред BuildKit-ржПрж░ ржорж╛ржзрзНржпржорзЗ ржЖржкржирж┐ ржЖржкржирж╛рж░ ржЗржорзЗржЬ рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рж┐рждрзЗ (Docker Hub/GHCR) ржХрзНржпрж╛рж╢ ржкрзБрж╢ ржХрж░рждрзЗ ржкрж╛рж░рзЗржиред

```bash
docker buildx build --push \
  --cache-from=user/app:cache \
  --cache-to=user/app:cache,mode=max \
  -t user/app:latest .
```

---

## рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк (Summary)
ржмрж┐рж▓рзНржб ржХрзНржпрж╛рж╢ ржЕржкрзНржЯрж┐ржорж╛ржЗржЬрзЗрж╢ржи ржЖржкржирж╛рж░ ржбрзЗржнрж▓ржкржорзЗржирзНржЯ рж▓рж╛ржЗржлрж╕рж╛ржЗржХрзЗрж▓ржХрзЗ ржЕржирзЗржХ ржмрзЗрж╢рж┐ ржлрж╛рж╕рзНржЯ ржХрж░рзЗред рж▓рзЗрзЯрж╛рж░рж┐ржВ ржЕрж░рзНржбрж╛рж░ ржПржмржВ BuildKit-ржПрж░ ржХрзНржпрж╛рж╢ ржорж╛ржЙржирзНржЯ ржлрж┐ржЪрж╛рж░ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ ржкрзНрж░рждрж┐ржЯрж┐ ржкрзНрж░ржлрзЗрж╢ржирж╛рж▓ ржбржХрж╛рж░ ржЗржЙржЬрж╛рж░рзЗрж░ ржЬрж╛ржирж╛ ржЙржЪрж┐рждред

---

> [!IMPORTANT]
> рж╕ржм рж╕ржорзЯ `.dockerignore` ржлрж╛ржЗрж▓ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи ржпрж╛рждрзЗ ржЕржкрзНрж░рзЯрзЛржЬржирзАрзЯ ржлрж╛ржЗрж▓ (ржпрзЗржоржи: `node_modules`, `.git`) ржХрзНржпрж╛рж╢ ржЗржиржнрзНржпрж╛рж▓рж┐ржб ржирж╛ ржХрж░рждрзЗ ржкрж╛рж░рзЗред
